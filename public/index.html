<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1"/>
    <title>Breezy Book - Old Sheep Ranch Inn</title>
    <link rel="stylesheet" href="css/main.css"/>
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-teal.min.css"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"/>
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css"/>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://cdn.jsdelivr.net/npm/litepicker@2.0.11/dist/litepicker.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/litepicker@2.0.11/dist/plugins/mobilefriendly.js"></script>
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
  </head>

  <body>
    <header>
      <a href="/" rel="home">Breezy Book</a>
    </header>

    <main>
      <p>
        This demo is in test mode. That means you can check out using any of the
        <a href="https://stripe.com/docs/testing#cards">test card numbers</a>.
      </p>

      <form id="bookWizForm" class="bookWiz">
        <!-- One "tab" for each step in the form: -->
        <div class="tab swiper-container" >Select a room:
          <div class="products swiper-wrapper"></div>
          <div class="swiper-pagination"></div>
          <input type="hidden" id="sku" name="sku" value="">
        </div>

        <div class="tab">Select dates of stay:
          <div style="max-width:300px;margin-left:auto;margin-right:auto;text-align:center;"><input type="text" id="datepicker"/></div>
          <div style="max-width:300px;margin-top:20px;margin-left:auto;margin-right:auto;">
            <label for="quantity">Number of nights selected:</label>
            <input style="max-width:40px;margin-top:20px;text-align:center;" type="number" id="quantity" name="quantity" value="1" min="1" disabled="disabled"/></div>
        </div>

        <div class="tab">Terms and conditions:
          <p>No dogs.</p>
          <p>Full terms, cancellation policy, etc.</p>
          <p>By clicking next you accept these terms.</p>
        </div>

        <div class="tab">Confirm details:
          <p id="roomNameDisplay"></p>
          <p id="dateRangeDisplay"></p>
          <p id="quantityNightsDisplay"></p>
          <p id="roomPriceDisplay"></p>
          <p id="roomTotalDisplay"></p>
          <p id="cleaningFeeDisplay"></p>
          <p id="appFeeDisplay"></p>
          <p id="taxDisplay"></p>
          <p id="totalDisplay"></p>
          <button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored" type="submit">Book Now</button>
        </div>

        <!-- Circles which indicates the steps of the form: -->
        <div class="steps">
          <span style="float:left;width:30%;">
            <button type="button" class="mdl-button mdl-js-button mdl-button--fab mdl-button--mini-fab mdl-button--colored mdl-js-ripple-effect" id="prevBtn" onclick="nextPrev(-1)">
              <i class="material-icons">arrow_back</i>
            </button>
          </span>
          <span class="step"></span>
          <span class="step"></span>
          <span class="step"></span>
          <span class="step"></span>
          <span style="float:right;width:30%;">
            <button type="button" class="mdl-button mdl-js-button mdl-button--fab mdl-button--mini-fab mdl-button--colored mdl-js-ripple-effect" id="nextBtn" onclick="nextPrev(1)">
              <i class="material-icons">arrow_forward</i>
            </button>
          </span>
        </div>

      </form>

    </main>

    <footer>
      <p>
        Booking with
        <a href="https://breezybook.app/">
          BreezyBook
        </a>
        is easy and
        <em>free</em>! ·
        <a href="https://github.com/stripe-samples/checkout-netlify-serverless">
          Stripe and Netlify Serverless Checkout
        </a>
      </p>
    </footer>

    <template id="product">
      <button onclick="" type="button" class="product swiper-slide demo-card-square mdl-card mdl-shadow--3dp mdl-button mdl-js-button mdl-js-ripple-effect">
        <h2 class="mdl-card__title-text">Update</h2>
        <div class="mdl-card__title mdl-card--expand"></div>
        <div class="description mdl-card__supporting-text">
          Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aenan convallis.
        </div>
        <div class="mdl-card__actions mdl-card--border">
          <div class="price">
            $0
          </div>
          <div class="mdl-layout-spacer"></div>
          <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--colored" target="_blank">
            More Info
          </a>
        </div>
      </button>
    </template>

    <script>
      var selectedSku = "";
      var selectedAvailability = [];
      var requestedDates = [];
      var requestedRange = "";
      var requestedCheckIn = "";
      var requestedCheckOut = "";
      var requestedRoomName = "";
      var requestedMinNights = 1;
      var requestedMinDays = 2;
      var requestedNumNights = 0;
      var requestedRoomPrice = 0;
      var requestedRoomTax = 0;
      var requestedRoomTotal = 0;
      var requestedRoomCleaningFee = 0;
      var taxPercent = 0;
      var taxTotal = 0;
      var appFeePercent = 0.05;
      var appFeeTotal = 0;
      var totalRequestPrice = 0;
      var calendar2Book = "";

      var currentTab = 0; // Current tab is set to be the first tab (0)
      showTab(currentTab); // Display the current tab

      function showTab(n) {
        // This function will display the specified tab of the form ...
        var x = document.getElementsByClassName("tab");
        x[n].style.display = "block";
        // ... and fix the Previous/Next buttons:
        if (n == 0) {
          document
            .getElementById("prevBtn")
            .style
            .visibility = "hidden";
        } else {
          document
            .getElementById("prevBtn")
            .style
            .visibility = "visible";
        }
        if (n == 1) {
          loadLitePicker(requestedMinDays, selectedAvailability);
        }
        if (n == 2) {
          calculateTotal(requestedRoomPrice,requestedNumNights,requestedRoomTax);
        }
        if (n == 3) {
          document
            .getElementById("roomNameDisplay")
            .innerText = "Room name: "+requestedRoomName;
          document
            .getElementById("roomPriceDisplay")
            .innerText = "$"+requestedRoomPrice/100+" per night";
          document
            .getElementById("roomTotalDisplay")
            .innerText = "Room x Nights = $"+requestedRoomTotal/100;
            document
            .getElementById("dateRangeDisplay")
            .innerText = "Dates requested: "+requestedRange;
          document
            .getElementById("quantityNightsDisplay")
            .innerText = "Number of Nights: "+requestedNumNights;
          document
            .getElementById("cleaningFeeDisplay")
            .innerText = "Cleaning fee: $"+requestedRoomCleaningFee/100;
          document
            .getElementById("appFeeDisplay")
            .innerText = "Online booking fee: $"+appFeeTotal/100;
          document
            .getElementById("taxDisplay")
            .innerText = "Rental tax: $"+taxTotal/100;
          document
            .getElementById("totalDisplay")
            .innerText = "Total: $"+totalRequestPrice/100;
        }
        if (n == (x.length - 1)) {
          document
            .getElementById("nextBtn")
            .style
            .visibility = "hidden";
        } else {
          document
            .getElementById("nextBtn")
            .style
            .visibility = "visible";
        }
        // ... and run a function that displays the correct step indicator:
        fixStepIndicator(n)
      }

      function nextPrev(n) {
        // This function will figure out which tab to display
        var x = document.getElementsByClassName("tab");
        // Exit the function if any field in the current tab is invalid:
        if (n == 1 && !validateForm()) 
          return false;
        
        // Hide the current tab:
        x[currentTab].style.display = "none";
        // Increase or decrease the current tab by 1:
        currentTab = currentTab + n;
        // if you have reached the end of the form... :
        if (currentTab >= x.length) {
          //...the form gets submitted:
          document
            .getElementById("bookWizForm")
            .submit();
          //return false;
        }
        // Otherwise, display the correct tab:
        showTab(currentTab);
      }

      function validateForm() {
        // This function deals with validation of the form fields
        var x,
          y,
          i,
          valid = true;
        x = document.getElementsByClassName("tab");
        y = x[currentTab].getElementsByTagName("input");
        // A loop that checks every input field in the current tab:
        for (i = 0; i < y.length; i++) {
          // If a field is empty...
          if (y[i].value == "") {
            // add an "invalid" class to the field:
            y[i].className += " invalid";
            // and set the current valid status to false:
            valid = false;
          }
        }
        // If the valid status is true, mark the step as finished and valid:
        if (valid) {
          document
            .getElementsByClassName("step")[currentTab]
            .className += " finish";
        }
        return valid; // return the valid status
      }

      function calculateTotal(roomCost,roomNights,roomTax) {
        requestedRoomTotal = roomCost * roomNights;
        taxPercent = roomTax/100;
        taxTotal = (requestedRoomTotal + requestedRoomCleaningFee) * taxPercent;
        appFeeTotal = (requestedRoomTotal + requestedRoomCleaningFee) * appFeePercent;
        totalRequestPrice = requestedRoomTotal + requestedRoomCleaningFee + taxTotal + appFeeTotal;
      }

      function fixStepIndicator(n) {
        // This function removes the "active" class of all steps...
        var i,
          x = document.getElementsByClassName("step");
        for (i = 0; i < x.length; i++) {
          x[i].className = x[i]
            .className
            .replace(" active", "");
        }
        //... and adds the "active" class to the current step:
        x[n].className += " active";
      }

      var bookedDates = [];

      function loadLitePicker(minDays, calAvail) {
        new Litepicker({
          element: document.getElementById('datepicker'),
          plugins: ['mobilefriendly'],
          singleMode: false,
          delimiter: " to ",
          autoRefresh: true,
          minDays: minDays,
          maxDays: 30,
          minDate: new Date().addDays(3),
          maxDate: new Date().addDays(270),
          dropdowns: {
            "minYear": new Date().getFullYear(),
            "maxYear": new Date().getFullYear() + 1,
            "months": true,
            "years": false
          },
          disallowLockDaysInRange: true,
          tooltipText: {
            one: 'night',
            other: 'nights'
          },
          lockDays: (calAvail),
          tooltipNumber: (totalDays) => {
            return totalDays - 1;
          },
          setup: (picker) => {
            picker.on('error:range', () => {
              console.log("A date in the range is already booked.")
            });
            picker.on('selected', (date1, date2) => {
              var selectedArr = getDaysArray(date1.format('YYYY-MM-DD'), date2.format('YYYY-MM-DD'));
              requestedDates = selectedArr;
              requestedCheckIn = date1.format('YYYY-MM-DD');
              requestedCheckOut = date2.format('YYYY-MM-DD');
              requestedRange = date1.format('YYYY-MM-DD') + " to " + date2.format('YYYY-MM-DD');
              requestedNumNights = selectedArr.length - 1;
              document
                .getElementById("quantity")
                .value = requestedNumNights;
            });
          }
        });
      };

      window.onload = function (e) {
        loadProducts();
        bookWizForm.addEventListener('submit', handleSubmit);
      };

      async function fetchBookedDates(calendarId) {
        console.log(calendarId);
        const availRequestBody = {
          calId: calendarId
        };

        const bookedDatesFetchSettings = {
          method: 'POST',
          body: JSON.stringify(availRequestBody),
          headers: {
            Accept: 'application/json',
            'Content-Type': 'application/json'
          }
        };

        const bookedDatesRes = await fetch('https://oldsheepranchinn.api.stdlib.com/availability@dev/', bookedDatesFetchSettings);

        if (!bookedDatesRes.ok) {
          const message = `An error has occured: ${bookedDatesRes.status}`;
          throw new Error(message);
        }

        var unAvailArr = await bookedDatesRes.json();
        console.log(unAvailArr);
        return unAvailArr;
      };

      fetchBookedDates().catch(error => {
        error.message; // 'An error has occurred: 404'
      });

      function dateToYMD(date) {
        var d = date.getDate();
        var m = date.getMonth() + 1; //Month from 0 to 11
        var y = date.getFullYear();
        return '' + y + '-' + (
          m <= 9
          ? '0' + m
          : m) + '-' + (
          d <= 9
          ? '0' + d
          : d);
      };

      Date.prototype.addDays = function (days) {
        var date = new Date(this.valueOf());
        date.setDate(date.getDate() + days);
        return date;
      };

      var getDaysArray = function (start, end) {
        var startdt = new Date(start);
        var enddt = new Date(end);
        for (var arr = [], dt = startdt; dt <= enddt; dt.setDate(dt.getDate() + 1)) {
          arr.push(new Date(dt));
        }
        return arr;
      };

      function format(amount, currency) {
        return new Intl
          .NumberFormat('en-US', {
            style: 'currency',
            currency
          })
          .format((amount / 100).toFixed(2));
      }

      function loadSwiper() {var swiper = new Swiper('.swiper-container', {
      effect: 'coverflow',
      grabCursor: true,
      centeredSlides: true,
      slidesPerView: 'auto',
      coverflowEffect: {
        rotate: 50,
        stretch: 0,
        depth: 100,
        modifier: 1,
        slideShadows: true,
      },
      freeMode: true,
      centeredSlides: true,
      grabCursor: true,
      });
    }
      function handleSelect(sku, name, price, minNight, cleanFee, availability, tax, calendarOut) {
        
        selectedSku = sku;
        requestedRoomName = name;
        requestedRoomPrice = parseInt(price);
        requestedMinNights = parseInt(minNight);
        requestedRoomCleaningFee = parseInt(cleanFee);
        requestedMinDays = parseInt(minNight) + 1;
        selectedAvailability = availability;
        requestedRoomTax = parseInt(tax);
        calendar2Book = calendarOut;
        document
            .getElementById("sku")
            .value = sku;
        var x = document.getElementsByClassName("product");
            var i;
            for (i = 0; i < x.length; i++) {
            x[i].style.backgroundColor = "";
        }
        document
            .getElementById(sku)
            .style.backgroundColor = 'rgb(100,255,218,0.5)';
      };

      async function handleSubmit(event) {
        try {
          event.preventDefault();
          document
            .querySelectorAll('button')
            .forEach((button) => (button.disabled = true));
          const form = new FormData(event.target);
          const data = {
            sku: selectedSku,
            nights: requestedNumNights,
            dates: requestedRange,
            checkin: requestedCheckIn,
            checkout: requestedCheckOut,
            calendar: calendar2Book
          };
          const response = await fetch('/.netlify/functions/create-checkout', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          }).then((res) => res.json());
          // remove the following for transfer, add the following immediatly after "response.publishableKey" for direct
          //, {stripeAccount: response.stripeAccount}
          const stripe = Stripe(response.publishableKey, {stripeAccount: response.stripeAccount});
          await stripe.redirectToCheckout({sessionId: response.sessionId});
        } catch (error) {
          console.log(error.message);
        }

      };

      async function loadProducts() {
        if (!'content' in document.createElement('template')) {
          console.error('Your browser doesn’t support HTML template elements.');
          return;
        }
        const products = document.querySelector('.products');
        const template = document.querySelector('#product');
        const data = await fetch('/.netlify/functions/get-products')
          .then((res) => res.json())
          .then(async function foo(res) {
            for (var i = 0; i < res.length; i++) {
              await new Promise(next => {
                const container = template
                  .content
                  .cloneNode(true);
                cardElement = container.querySelector('.product');
                let product = res[i];
                let productAvailability = [];
                let JSONavailability = "";
                fetchBookedDates(product.calendar)
                  .then(function (fetchBookedDatesRes) {
                    unAvailArr = fetchBookedDatesRes.gcal.response.items;
                    unAvailArr.forEach(function (event) {
                      let eventStartEndArr = [event.start.date, event.end.date]
                      productAvailability.push(eventStartEndArr);
                    });
                    JSONavailability = JSON.stringify(productAvailability);
                    cardElement.setAttribute("onClick", 'javascript: handleSelect("' + product.sku + '","' + product.name + '","' + product.amount + '","' + product.min_night + '","' + product.clean_fee + '",' + JSONavailability + ',"' + product.tax + '","' + product.calendarOut + '");');
                    cardElement.setAttribute("id", product.sku);
                    next()
                  }, function (error) {
                    console.log(error)
                  });

                container
                  .querySelector('.mdl-card__title-text')
                  .innerText = product.name;

                titleElement = container.querySelector('.mdl-card__title');
                titleElement.style.background = "url(" + product.image + ") center center no-repeat";
                titleElement.style.backgroundSize="contain"

                container
                  .querySelector('.description')
                  .innerText = product.description;

                actionsElement = container.querySelector('.mdl-card__actions');
                actionsElement
                  .querySelector('.price')
                  .innerText = format(product.amount, product.currency) + ' / night';
                actionsElement
                  .querySelector('.mdl-button')
                  .setAttribute("href", product.more_info);

                products.appendChild(container);
                loadSwiper();
              })
            }

          }
          ).catch((err) => console.error(err));
      };
    </script>
  </body>

</html>
